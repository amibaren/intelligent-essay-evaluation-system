"""
åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åŸºäºOxyGentçš„AIä½œæ–‡è¯„å®¡å°ç»„
"""

import asyncio
import os
from pathlib import Path

from dotenv import load_dotenv
from oxygent import MAS, oxy, Config
from oxygent.utils.env_utils import get_env_var

# ç¡®ä¿ç¯å¢ƒå˜é‡åŠ è½½
load_dotenv()

# è®¾ç½®OxyGenté…ç½®
Config.set_agent_llm_model("default_llm")

# å®šä¹‰ç®€åŒ–çš„OxyGentç©ºé—´ç”¨äºæ¼”ç¤º
demo_oxy_space = [
    # LLMé…ç½®
    oxy.HttpLLM(  # type: ignore
        name="default_llm",
        api_key=get_env_var("DEFAULT_LLM_API_KEY"),
        base_url=get_env_var("DEFAULT_LLM_BASE_URL"),
        model_name=get_env_var("DEFAULT_LLM_MODEL_NAME"),
        llm_params={"temperature": 0.7},
        semaphore=2,
        timeout=120,
    ),
    
    # æ–‡æœ¬åˆ†æå¸ˆ - ä½¿ç”¨ChatAgent
    oxy.ChatAgent(  # type: ignore
        name="text_analyst",
        desc="æ–‡æœ¬åˆ†æå¸ˆï¼Œè´Ÿè´£åˆ†æä½œæ–‡çš„å„ä¸ªç»´åº¦",
        prompt="""ä½ æ˜¯ä¸€ä½ä¸¥è°¨çš„æ–‡æœ¬åˆ†æå¸ˆï¼Œè¯·å®¢è§‚åˆ†æä½œæ–‡çš„ä»¥ä¸‹æ–¹é¢ï¼š
1. åŸºç¡€è§„èŒƒï¼šå­—æ•°ã€æ®µè½ã€é”™è¯¯
2. å†…å®¹ç»“æ„ï¼šä¸»é¢˜ã€é€»è¾‘ã€å®Œæ•´æ€§
3. è¯­è¨€äº®ç‚¹ï¼šä¼˜ç¾è¡¨è¾¾ã€ä¿®è¾æ‰‹æ³•
4. æ”¹è¿›å»ºè®®ï¼šå¯ä»¥æå‡çš„åœ°æ–¹

è¯·ä»¥ç»“æ„åŒ–çš„æ–¹å¼è¾“å‡ºåˆ†æç»“æœã€‚""",
    ),
    
    # èµç¾é¼“åŠ±å¸ˆ - ä½¿ç”¨ChatAgent
    oxy.ChatAgent(  # type: ignore
        name="praiser",
        desc="èµç¾é¼“åŠ±å¸ˆï¼Œä¸“é—¨å‘ç°å’Œè¡¨æ‰¬å­¦ç”Ÿä½œæ–‡çš„äº®ç‚¹",
        prompt="""ä½ æ˜¯å……æ»¡çƒ­æƒ…çš„"é˜³å…‰è€å¸ˆ"ï¼Œä¸“é—¨å‘ç°å­¦ç”Ÿä½œæ–‡çš„äº®ç‚¹ï¼š
- ç”¨å…·ä½“çš„ä¾‹å­è¿›è¡Œè¡¨æ‰¬
- è¯­æ°”æ¸©æš–é¼“åŠ±ï¼Œå……æ»¡æ­£èƒ½é‡
- é‡ç‚¹è¡¨æ‰¬ä¼˜ç¾çš„è¡¨è¾¾å’Œç”¨å¿ƒçš„åœ°æ–¹
- è®©å­¦ç”Ÿæ„Ÿå—åˆ°å†™ä½œçš„å¿«ä¹

è¯·ç”Ÿæˆæ¸©æš–å…·ä½“çš„è¡¨æ‰¬å†…å®¹ã€‚""",
    ),
    
    # å¯å‘å¼•å¯¼å¸ˆ - ä½¿ç”¨ChatAgent  
    oxy.ChatAgent(  # type: ignore
        name="guide",
        desc="å¯å‘å¼•å¯¼å¸ˆï¼Œé€šè¿‡æé—®å¼•å¯¼å­¦ç”Ÿæ€è€ƒæ”¹è¿›æ–¹å‘",
        prompt="""ä½ æ˜¯æ¸©å’Œçš„"å¯å‘å¼•å¯¼å¸ˆ"ï¼Œé€šè¿‡é—®é¢˜å¼•å¯¼å­¦ç”Ÿæ€è€ƒï¼š
- ä¸ç›´æ¥æŒ‡å‡ºé”™è¯¯ï¼Œè€Œæ˜¯ç”¨é—®é¢˜å¯å‘
- å¼•å¯¼å­¦ç”Ÿè‡ªå·±å‘ç°å¯ä»¥æ”¹è¿›çš„åœ°æ–¹
- æä¾›æ€è€ƒçš„æ–¹å‘å’Œè§’åº¦
- è¯­æ°”æ¸©å’Œï¼Œç»™å­¦ç”Ÿæ€è€ƒçš„ç©ºé—´

è¯·è®¾è®¡å¯å‘æ€§çš„é—®é¢˜å’Œå»ºè®®ã€‚""",
    ),
    
    # ä¸»æ§æ™ºèƒ½ä½“ - ä½¿ç”¨ReActAgent
    oxy.ReActAgent(
        name="master_agent",
        desc="AIä½œæ–‡è¯„å®¡å°ç»„çš„ä¸»æ§æ™ºèƒ½ä½“ï¼Œåè°ƒå„ä¸“ä¸šæ™ºèƒ½ä½“å®Œæˆä½œæ–‡è¯„ä»·",
        prompt="""ä½ æ˜¯AIä½œæ–‡è¯„å®¡å°ç»„çš„ä¸»æ§æ™ºèƒ½ä½“ã€‚

å½“ç”¨æˆ·æäº¤ä½œæ–‡æ—¶ï¼Œä½ éœ€è¦ï¼š
1. å…ˆè°ƒç”¨text_analyståˆ†æä½œæ–‡
2. ç„¶åè°ƒç”¨praiserç”Ÿæˆè¡¨æ‰¬å†…å®¹  
3. æ¥ç€è°ƒç”¨guideç”Ÿæˆå¯å‘å»ºè®®
4. æœ€åæ•´åˆæ‰€æœ‰ç»“æœç”Ÿæˆç»¼åˆè¯„ä»·æŠ¥å‘Š

è¯·æŒ‰ç…§è¿™ä¸ªæµç¨‹åè°ƒå„ä¸ªæ™ºèƒ½ä½“å·¥ä½œã€‚""",
        is_master=True,
        sub_agents=["text_analyst", "praiser", "guide"],
        llm_model="default_llm",
        max_react_rounds=5,
    ),
]


async def demo_basic_usage():
    """åŸºç¡€ä½¿ç”¨æ¼”ç¤º"""
    print("ğŸš€ å¯åŠ¨AIä½œæ–‡è¯„å®¡å°ç»„æ¼”ç¤º...")
    
    # ç¤ºä¾‹ä½œæ–‡
    sample_essay = """
æˆ‘çš„å¦ˆå¦ˆ

æˆ‘çš„å¦ˆå¦ˆæ˜¯ä¸€ä½æ¸©æŸ”çš„è€å¸ˆã€‚å¥¹æœ‰ä¸€åŒæ˜äº®çš„çœ¼ç›ï¼Œå°±åƒå¤©ç©ºä¸­é—ªçƒçš„æ˜Ÿæ˜Ÿã€‚æ¯å¤©æ—©ä¸Šï¼Œå¦ˆå¦ˆéƒ½ä¼šä¸ºæˆ‘å‡†å¤‡ç¾å‘³çš„æ—©é¤ï¼Œè¿˜ä¼šæ¸©æŸ”åœ°å«æˆ‘èµ·åºŠã€‚

å¦ˆå¦ˆå·¥ä½œå¾ˆå¿™ï¼Œä½†å¥¹æ€»æ˜¯æŠ½æ—¶é—´é™ªæˆ‘åšä½œä¸šã€‚å½“æˆ‘é‡åˆ°ä¸ä¼šçš„é¢˜ç›®æ—¶ï¼Œå¦ˆå¦ˆä¼šè€å¿ƒåœ°æ•™æˆ‘ï¼Œä»ä¸å‘è„¾æ°”ã€‚å¥¹çš„ç¬‘å®¹åƒæ˜¥å¤©çš„èŠ±æœµä¸€æ ·ç¾ä¸½ï¼Œæ€»æ˜¯è®©æˆ‘æ„Ÿåˆ°æ¸©æš–ã€‚

æˆ‘çˆ±æˆ‘çš„å¦ˆå¦ˆï¼Œå¥¹æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„å¦ˆå¦ˆã€‚æˆ‘è¦å¥½å¥½å­¦ä¹ ï¼Œé•¿å¤§ååƒå¦ˆå¦ˆä¸€æ ·å¸®åŠ©åˆ«äººã€‚
    """.strip()
    
    try:
        async with MAS(oxy_space=demo_oxy_space) as mas:
            print("âœ… OxyGent MASç³»ç»Ÿå¯åŠ¨æˆåŠŸ")
            
            # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
            mas.show_mas_info()
            
            # æ¨¡æ‹Ÿä½œæ–‡è¯„ä»·æµç¨‹
            print("\nğŸ“ å¼€å§‹è¯„ä»·ç¤ºä¾‹ä½œæ–‡...")
            print(f"ä½œæ–‡å†…å®¹ï¼š\n{sample_essay}\n")
            
            # è°ƒç”¨ä¸»æ§æ™ºèƒ½ä½“å¤„ç†ä½œæ–‡
            result = await mas.call(
                callee="master_agent",
                arguments={
                    "query": f"è¯·è¯„ä»·ä»¥ä¸‹å°å­¦ç”Ÿä½œæ–‡ï¼š\n\n{sample_essay}"
                }
            )
            
            print("ğŸ“Š è¯„ä»·ç»“æœï¼š")
            print(result)
            
            # ä¹Ÿå¯ä»¥å•ç‹¬è°ƒç”¨å„ä¸ªæ™ºèƒ½ä½“
            print("\nğŸ” å•ç‹¬è°ƒç”¨æ–‡æœ¬åˆ†æå¸ˆ...")
            analysis_result = await mas.call(
                callee="text_analyst", 
                arguments={"query": f"è¯·åˆ†æè¿™ç¯‡ä½œæ–‡ï¼š\n{sample_essay}"}
            )
            print(f"åˆ†æç»“æœï¼š{analysis_result}")
            
    except Exception as e:
        print(f"âŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")


async def demo_interactive_chat():
    """äº¤äº’å¼å¯¹è¯æ¼”ç¤º"""
    print("ğŸ—£ï¸ å¯åŠ¨äº¤äº’å¼å¯¹è¯æ¨¡å¼...")
    
    try:
        async with MAS(oxy_space=demo_oxy_space) as mas:
            print("âœ… ç³»ç»Ÿå°±ç»ªï¼Œå¯ä»¥å¼€å§‹å¯¹è¯")
            
            # å¯åŠ¨WebæœåŠ¡è¿›è¡Œäº¤äº’
            await mas.start_web_service(
                first_query="ä½ å¥½ï¼æˆ‘æ˜¯AIä½œæ–‡è¯„å®¡å°ç»„ã€‚è¯·æäº¤ä½ çš„ä½œæ–‡ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘ä½ çš„æ•™å­¦éœ€æ±‚ã€‚"
            )
            
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ç”¨æˆ·ä¸»åŠ¨é€€å‡º")
    except Exception as e:
        print(f"âŒ äº¤äº’è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")


async def demo_batch_processing():
    """æ‰¹é‡å¤„ç†æ¼”ç¤º"""
    print("ğŸ“š æ‰¹é‡å¤„ç†æ¼”ç¤º...")
    
    # å¤šç¯‡ç¤ºä¾‹ä½œæ–‡
    sample_essays = [
        {
            "title": "æˆ‘çš„å­¦æ ¡",
            "content": "æˆ‘çš„å­¦æ ¡å¾ˆç¾ä¸½ã€‚æ ¡å›­é‡Œæœ‰é«˜å¤§çš„æ¢§æ¡æ ‘ï¼Œè¿˜æœ‰æ¼‚äº®çš„èŠ±å›ã€‚åŒå­¦ä»¬åœ¨æ“åœºä¸Šå¿«ä¹åœ°ç©è€ï¼Œè€å¸ˆä»¬è®¤çœŸåœ°å·¥ä½œã€‚æˆ‘çˆ±æˆ‘çš„å­¦æ ¡ã€‚"
        },
        {
            "title": "æ˜¥å¤©æ¥äº†", 
            "content": "æ˜¥å¤©æ¥äº†ï¼Œå°è‰ä»åœ°ä¸‹æ¢å‡ºå¤´æ¥ã€‚æŸ³æ ‘å‘èŠ½äº†ï¼Œåƒå°å§‘å¨˜çš„è¾«å­åœ¨é£ä¸­é£˜èˆã€‚ç‡•å­ä»å—æ–¹é£å›æ¥äº†ï¼Œåœ¨å¤©ç©ºä¸­è‡ªç”±åœ°é£ç¿”ã€‚æ˜¥å¤©çœŸç¾å•Šï¼"
        },
        {
            "title": "æˆ‘çš„å¥½æœ‹å‹",
            "content": "æˆ‘æœ‰ä¸€ä¸ªå¥½æœ‹å‹å«å°æ˜ã€‚ä»–å¾ˆèªæ˜ï¼Œå­¦ä¹ æˆç»©å¾ˆå¥½ã€‚ä»–ä¹Ÿå¾ˆå–„è‰¯ï¼Œæ€»æ˜¯å¸®åŠ©åŒå­¦ã€‚æˆ‘ä»¬ç»å¸¸ä¸€èµ·ç©æ¸¸æˆï¼Œä¸€èµ·å­¦ä¹ ã€‚å‹è°Šè®©æˆ‘ä»¬éƒ½å¾ˆå¿«ä¹ã€‚"
        }
    ]
    
    try:
        async with MAS(oxy_space=demo_oxy_space) as mas:
            print(f"ğŸ“ å¼€å§‹æ‰¹é‡å¤„ç† {len(sample_essays)} ç¯‡ä½œæ–‡...")
            
            for i, essay in enumerate(sample_essays, 1):
                print(f"\n--- å¤„ç†ç¬¬ {i} ç¯‡ä½œæ–‡ï¼š{essay['title']} ---")
                
                result = await mas.call(
                    callee="master_agent",
                    arguments={
                        "query": f"è¯·è¯„ä»·ä½œæ–‡ã€Š{essay['title']}ã€‹ï¼š\n\n{essay['content']}"
                    }
                )
                
                print(f"âœ… è¯„ä»·å®Œæˆ")
                # å¯ä»¥åœ¨è¿™é‡Œä¿å­˜ç»“æœåˆ°æ–‡ä»¶
                
            print(f"\nğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆï¼å…±å¤„ç† {len(sample_essays)} ç¯‡ä½œæ–‡")
            
    except Exception as e:
        print(f"âŒ æ‰¹é‡å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")


async def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¯ AIä½œæ–‡è¯„å®¡å°ç»„ - åŸºç¡€ä½¿ç”¨ç¤ºä¾‹")
    print("åŸºäºOxyGentå¤šæ™ºèƒ½ä½“æ¡†æ¶æ„å»º")
    print("=" * 50)
    
    # æ£€æŸ¥ç¯å¢ƒé…ç½®
    if not get_env_var("DEFAULT_LLM_API_KEY"):
        print("âŒ è¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡ DEFAULT_LLM_API_KEY")
        return
    
    while True:
        print("\nè¯·é€‰æ‹©æ¼”ç¤ºæ¨¡å¼ï¼š")
        print("1. åŸºç¡€ä½¿ç”¨æ¼”ç¤º")
        print("2. äº¤äº’å¼å¯¹è¯æ¨¡å¼") 
        print("3. æ‰¹é‡å¤„ç†æ¼”ç¤º")
        print("4. é€€å‡º")
        
        choice = input("\nè¯·è¾“å…¥é€‰æ‹© (1-4): ").strip()
        
        if choice == "1":
            await demo_basic_usage()
        elif choice == "2":
            await demo_interactive_chat()
        elif choice == "3":
            await demo_batch_processing()
        elif choice == "4":
            print("ğŸ‘‹ å†è§ï¼")
            break
        else:
            print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")


if __name__ == "__main__":
    asyncio.run(main())